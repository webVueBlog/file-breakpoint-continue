## å®ç°å¤§æ–‡ä»¶ä¸Šä¼ å’Œæ–­ç‚¹ç»­ä¼ å®è·µç»éªŒæ€»ç»“

ğŸ’¬ å¾®ä¿¡äº¤æµ: xiaoda0423âš¡ ğŸ‘‰ å¦‚æœä½ æœ‰é—®é¢˜

å®ç°æ–‡ä»¶ä¸Šä¼ ï¼Œå¤§æ–‡ä»¶ï¼Œä»¥åŠå¦‚ä½•æ–­ç‚¹ç»­ä¼ ç­‰æŠ€æœ¯å®ç°ç»†èŠ‚ï¼Œæˆ‘ä¼šæ¯ä¸ªç»†èŠ‚ï¼Œæ¯ä¸ªä»£ç éƒ½å†™å‡ºæ¥ï¼Œä¸€èµ·è°ƒè¯•ï¼Œä¸€èµ·è·Ÿç€æ­¥éª¤ä¸€ä¸€å®ç°ã€‚

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1913f810083f4f74aa7063fa1bbe2cad~tplv-k3u1fbpfcp-watermark.image?)

## å¤§æ–‡ä»¶ä¸Šä¼ æŠ€æœ¯è¦ç‚¹åˆ†æ

æŠ€æœ¯è¦ç‚¹åˆ†æï¼š

- `e6`æ–‡ä»¶å¯¹è±¡ï¼Œ`ajax`ä¸Šä¼ ï¼Œ`async await promise`ï¼Œåå°æ–‡ä»¶å­˜å‚¨ï¼Œæµæ“ä½œï¼ˆå†™å…¥åˆ°æœåŠ¡å™¨é‡Œé¢å»ï¼‰ã€‚
- ä¸€ä¸ªæ–‡ä»¶ä¼ ç»Ÿä¸Šä¼  `8M`ï¼Œç°åœ¨æ–‡ä»¶ä¸Šä¼ ä¸€èˆ¬å¾ˆå¤§çš„æ–‡ä»¶ï¼Œå°±è¦è€ƒè™‘åˆ‡ç‰‡é—®é¢˜ï¼Œå®ç°å¤§æ–‡ä»¶ä¸Šä¼ ã€‚
- `js` åœ¨ `es6` æ–‡ä»¶å¯¹è±¡ `file node stream` æœ‰æ‰€å¢å¼ºã€‚ä»»ä½•æ–‡ä»¶éƒ½æ˜¯äºŒè¿›åˆ¶ï¼Œåˆ†éš”`blob`ï¼ˆæ–‡ä»¶çš„ä¸€ç§ç±»å‹ï¼‰ã€‚
- ä¸€ä¸ªå¤§çš„æ–‡ä»¶å¯ä»¥åˆ†è§£ä¸ºä»å“ªä¸ªä½ç½®å¼€å§‹ `start`ï¼Œæ¯ä¸€å—å¤šå°`sizeï¼Œoffset`ã€‚
- `http`è¯·æ±‚ï¼Œ`n`ä¸ªåˆ‡ç‰‡å¯ä»¥å¹¶å‘ä¸Šä¼ ã€‚æ ¸å¿ƒåˆ©ç”¨ `Blob.prototype.slice` æ–¹æ³•ï¼Œè°ƒç”¨çš„`slice`æ–¹æ³•å¯ä»¥è¿”å› åŸæ–‡ä»¶çš„æŸä¸ªåˆ‡ç‰‡ã€‚ï¼ˆé€Ÿåº¦æ›´å¿«ï¼Œæ”¹å–„äº†ä½“éªŒï¼‰
- é¢„å…ˆè®¾ç½®å¥½çš„åˆ‡ç‰‡æœ€å¤§æ•°é‡å°†æ–‡ä»¶åˆ‡åˆ†ä¸ºä¸€ä¸ªä¸ªåˆ‡ç‰‡ï¼Œç„¶åå€ŸåŠ©`http`çš„å¯å¹¶å‘æ€§ï¼ŒåŒæ—¶ä¸Šä¼ å¤šä¸ªåˆ‡ç‰‡ï¼Œè¿™æ ·ä»åŸæœ¬ä¼ ä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œå˜æˆäº†åŒæ—¶ä¼ å¤šä¸ªå°çš„æ–‡ä»¶åˆ‡ç‰‡ï¼Œå¯ä»¥å¤§å¤§å‡å°‘ä¸Šä¼ æ—¶é—´ã€‚
- ç”±äºæ˜¯å¹¶å‘ï¼Œä¼ è¾“åˆ°æœåŠ¡å™¨çš„é¡ºåºå¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ç»™æ¯ä¸ªåˆ‡ç‰‡è®°å½•é¡ºåºã€‚(å‰ç«¯çš„åˆ‡ç‰‡ä¸Šä¼ ï¼Œè®©`http`å¹¶å‘å¸¦æ¥ä¸Šä¼ å¤§æ–‡ä»¶çš„å¿«æ„Ÿã€‚

## å¤§æ–‡ä»¶ä¸Šä¼ å‰ç«¯

åˆ›å»º`big_file_upload`ç›®å½•æ–‡ä»¶ï¼Œåˆå§‹åŒ–`node`çš„é¡¹ç›®ï¼š `npm init -y`ï¼Œç”Ÿæˆ`package.json`æ–‡ä»¶ã€‚åˆ›å»º`file_slice.html`æ–‡ä»¶ï¼Œæ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ ï¼Œåˆ‡ç‰‡çš„è¿‡ç¨‹ï¼Œä»¥åŠè¯´æ˜ä»£ç çš„æ„ä¹‰ã€‚

`live-server`å¯åŠ¨ä¸€ä¸‹æˆ‘ä»¬æœ¬åœ°çš„æœåŠ¡å™¨ï¼Œå®ƒæ˜¯`npm`çš„ä¸€ä¸ªåŒ…ï¼Œå¯ä»¥ä¸‹è½½`npm i -g live-server`ã€‚ä¹Ÿå¯ä»¥ä¸‹è½½`vs code`é‡Œ`live server`æ’ä»¶ã€‚å¯åŠ¨`.html`æ–‡ä»¶ã€‚

## file_sliceæ–‡ä»¶

`file_slice.html`ä»£ç ï¼š

```html
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
	</head>
	<body>
		<input type="file" id="file">
		<script>
			document.getElementById('file')
			.addEventListener('change', (event) => {
				const file = event.target.files[0]; // es6 æ–‡ä»¶å¯¹è±¡
				// console.log(file);
				// console.log(Object.prototype.toString.call(file)); // [object File]
				// console.log(Object.prototype.toString.call(file.slice(0, 102400))); // [object Blob]
				let cur = 0, size = 1024*1024; // 1M
				// blobç­‰å¾…ä¸Šä¼ çš„å¯¹è±¡ï¼Œæ‰€æœ‰çš„åˆ‡ç‰‡ä¸Šä¼ å®Œ
				const fileChunkList = []; // blobæ•°ç»„
				while(cur < file.size) {
					fileChunkList.push({
						// cur start offset end
						file: file.slice(cur, cur + size)
					});
					cur += size;
				}
				console.log(fileChunkList)
			})
		</script>
	</body>
</html>
```

- `file.slice`å®Œæˆåˆ‡ç‰‡ï¼Œ`blob`ç±»å‹æ–‡ä»¶åˆ‡ç‰‡ï¼Œ`js`äºŒè¿›åˆ¶æ–‡ä»¶ç±»å‹çš„`blob`åè®®ã€‚åœ¨æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨ä¹‹å‰å°±å¯ä»¥æå‰é¢„è§ˆã€‚

```js
è¿”å›æ–‡æ¡£æœ€åä¿®æ”¹çš„æ—¥æœŸå’Œæ—¶é—´  lastModified:Â xxxx891269598
è¿”å›æ–‡æ¡£æœ€åä¿®æ”¹çš„æ—¥æœŸå’Œæ—¶é—´  lastModifiedDate:Â Tue Feb 15 xxxx 10:14:29 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´)Â {}
åå­—  name:Â "JavaScripté«˜çº§ç¨‹åºè®¾è®¡ï¼ˆç¬¬4ç‰ˆï¼‰.pdf"
å¤§å°  size:Â 14355650
ç±»å‹  type:Â "application/pdf"
ç½‘ç»œå·¥å…·åŒ…ç›¸å¯¹è·¯å¾„  webkitRelativePath:Â ""
```

```js
size:Â 102400
type:Â ""
[[Prototype]]:Â Blob
```

```js
(14)Â [{â€¦}, {â€¦}, {â€¦}, {â€¦}, {â€¦}, {â€¦}, {â€¦}, {â€¦}, {â€¦}, {â€¦}, {â€¦}, {â€¦}, {â€¦}, {â€¦}]
0:Â {file:Â Blob}
1:Â {file:Â Blob}
2:Â {file:Â Blob}
3:Â {file:Â Blob}
4:Â {file:Â Blob}
5:Â {file:Â Blob}
6:Â {file:Â Blob}
7:Â {file:Â Blob}
8:Â {file:Â Blob}
9:Â {file:Â Blob}
10:Â {file:Â Blob}
11:Â {file:Â Blob}
12:Â {file:Â Blob}
13:Â {file:Â Blob}
length:Â 14
```

## Blob.slice

`Blob.slice()` æ–¹æ³•ç”¨äºåˆ›å»ºä¸€ä¸ªåŒ…å«æº `Blob` çš„æŒ‡å®šå­—èŠ‚èŒƒå›´å†…çš„æ•°æ®çš„æ–° `Blob` å¯¹è±¡ã€‚

> è¿”å›å€¼

ä¸€ä¸ªæ–°çš„ `Blob` å¯¹è±¡ï¼Œå®ƒåŒ…å«äº†åŸå§‹ `Blob` å¯¹è±¡çš„æŸä¸€ä¸ªæ®µçš„æ•°æ®ã€‚

## blobæ–‡ä»¶

åŒç›®å½•ä¸‹åˆ›å»º `blob.html`æ–‡ä»¶ï¼Œä»£ç ï¼š

```html
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
	</head>
	<body>
		<img src="" alt="" id="pic" width="350px">
		<input type="file" id="file" />
		<script>
			// es6 fileå¯¹è±¡ blob blob:// åœ¨æ–‡ä»¶ä¸Šä¼ è§£å†³çš„é—®é¢˜ã€‚
			// ä¼ ç»Ÿes5æ—¶ä»£æ–‡ä»¶åªæœ‰ä¸Šä¼ åˆ°æœåŠ¡å™¨åï¼Œé™æ€æœåŠ¡æä¾›ä¸€ä¸ªè¿œç¨‹åœ°å€ç»™æˆ‘ä»¬ï¼Œæ‰èƒ½å¤Ÿçœ‹åˆ°æˆ‘ä»¬ä¸Šä¼ çš„è¿™å¼ å›¾ç‰‡ã€‚
			// es6åœ¨æœ¬åœ°å®¢æˆ·ç«¯æ“ä½œæ–‡ä»¶çš„èƒ½åŠ›  fileå¯¹è±¡ã€‚
			// blob åè®®åœ¨æœ¬åœ°å°±æŠŠå®ƒç«‹é©¬æ˜¾ç¤ºå‡ºæ¥ï¼Œé…ä¸Šä¸Šä¼ è¿›åº¦ï¼Œæ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚
			document.getElementById('file').addEventListener('change', (e) => {
				const file = e.target.files[0];
				const URL = window.URL;
				const objectUrl = URL.createObjectURL(file);
				console.log(objectUrl);

				const pic = document.getElementById('pic');
				pic.src = objectUrl;
				pic.onload = function() {
					URL.revokeObjectURL(objectUrl); // åè®®åœ°å€ é‡Šæ”¾
				}
			})
		</script>
	</body>
</html>
```

é¢„è§ˆæ•ˆæœï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/df5d7a13063649b1b264f5d6b57297d0~tplv-k3u1fbpfcp-watermark.image?)

## æ€è·¯æ­¥éª¤

åˆ‡ç‰‡ï¼Œ`target`ç›®æ ‡åç«¯æ–‡ä»¶ä¸‹ä»¥åå­—ä¸ºç›®å½•çš„æ–‡ä»¶ï¼›æœåŠ¡å™¨ç«¯ï¼Œå¦‚æ¶åŒ–å°†è¿™äº›åˆ‡ç‰‡ï¼Œåˆå¹¶æˆä¸€ä¸ªï¼Œå¹¶ä¸”æ˜¾ç¤ºåŸæ¥çš„å›¾ç‰‡ï¼Œå¯¹äºæœåŠ¡å™¨ç«¯`node`æµ `stream` çš„æ¦‚å¿µã€‚

å¼€å§‹åœ¨`big_file_upload`æ–‡ä»¶ä¸‹åˆ›å»º`server`ç›®å½•ï¼Œåˆå§‹åŒ–ä¸€ä¸‹`npm init -y`ï¼Œç”Ÿæˆ`package.json`æ–‡ä»¶ï¼Œæ·»åŠ ä¸€ä¸‹æˆ‘ä»¬çš„å…¥å£æ–‡ä»¶ï¼Œ`index.js`æ–‡ä»¶ã€‚

åˆ›å»ºæ–‡ä»¶ç›®å½•ï¼š

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a118a7e0c5d54e8a8c6f0f3a9f1b0954~tplv-k3u1fbpfcp-watermark.image?)

è¯´æ˜ï¼š`server`åç«¯æœåŠ¡ï¼Œ`target`å­˜å‚¨æ–‡ä»¶ï¼ŒæŸæ–‡ä»¶ä¸‹ç­‰

`server`ç›®å½•ä¸‹çš„`index.js`æ–‡ä»¶ä»£ç ï¼š

```js
const path = require('path'); // è·¯å¾„
const fse = require('fs-extra'); // fsæ‰©å±•åŒ…
// ä¸Šä¼ ç›®å½•
const UPLOAD_DIR = path.resolve(__dirname, ".", "target"); // server/target
// console.log(UPLOAD_DIR);
const filename = 'da';
const filePath = path.resolve(UPLOAD_DIR, '..', `${filename}.mp3`); // è·¯å¾„
console.log(filePath); // æ ¹ç›®å½•ä¸‹

const pipeStream = (path, writeStream) =>
 new Promise(resolve => {
  const readStream = fse.createReadStream(path);
  readStream.on('end',() => {
   fse.unlinkSync(path); // ç§»é™¤
   resolve();
  })
  readStream.pipe(writeStream);
 })

const mergeFileChunk = async (filePath, filename, size) => {
 // console.log(filePath, filename, size)
 // å¤§æ–‡ä»¶ä¸Šä¼ æ—¶ï¼Œè®¾è®¡åç«¯æ€æƒ³æ—¶æ¯ä¸ªè¦ä¸Šä¼ çš„æ–‡ä»¶ï¼Œå…ˆä»¥æ–‡ä»¶åï¼Œ
 // ä¸ºtargetç›®å½•åï¼ŒæŠŠåˆ†æ–‡ä»¶blobï¼Œæ”¾å…¥è¿™ä¸ªç›®å½•
 // æ–‡ä»¶blobä¸Šä¼ å‰è¦åŠ ä¸Šindex
 // node æ–‡ä»¶åˆå¹¶è‚¯å®šå¯ä»¥çš„ï¼Œstream
 const chunkDir = path.resolve(UPLOAD_DIR, filename);
 // console.log(chunkDir);
 const chunkPaths = await fse.readdir(chunkDir);
 // console.log(chunkPaths); // è·¯å¾„ä¸‹çš„æ•°ç»„æ–‡ä»¶å
 chunkPaths.sort((a, b) => a.split('-')[1] - b.split('-')[1]);
 // console.log(chunkPaths, '++');
 // æ¯å—å†…å®¹å†™å…¥æœ€åçš„æ–‡ä»¶ï¼Œpromise
 await Promise.all(
  chunkPaths.map((chunkPath, index) =>
   pipeStream(
    // å›æµçš„æ–¹æ³•
    path.resolve(chunkDir, chunkPath),
    fse.createWriteStream(filePath, {
     start: index * size,
     end: (index + 1) * size
    })
   )
  )
 )
 // console.log('æ–‡ä»¶åˆå¹¶æˆåŠŸ');
 fse.rmdirSync(chunkDir); // åˆ é™¤
}

mergeFileChunk(filePath, filename, 0.5*1024*1024);
```

- `fs`æä¾›æ–‡ä»¶çš„è¯»å†™ï¼Œåˆ é™¤ï¼Œæ–‡ä»¶çš„ç§»åŠ¨ï¼Œæ–‡ä»¶çš„ç›®å½•ï¼Œæ–‡ä»¶çš„ç›®å½•æŸ¥çœ‹ç­‰ç­‰
- `yarn add fs-extra`
- `yarn global add nodemon`
- `stream`æµ
- å¯è¯»æµï¼Œå¯å†™æµ
- `chunk`éƒ½æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æµæ–‡ä»¶
- `Promise.all` æ¥åŒ…è£…æ¯ä¸ª`chunk`çš„å†™å…¥
- `start end` `fse createWriteStream`
- æ¯ä¸ª`chunk`å†™å…¥ å…ˆåˆ›å»ºå¯è¯»æµï¼Œå†`pipe`ç»™å¯å†™æµçš„è¿‡ç¨‹ã€‚

æ€è·¯ï¼šä»¥åŸæ–‡ä»¶åšä¸ºæ–‡ä»¶å¤¹çš„åå­—ï¼Œåœ¨ä¸Šä¼ `blobs`åˆ°è¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œå‰ä¸”æ¯ä¸ª`blob` éƒ½ä»¥æ–‡ä»¶-`index`çš„å‘½åæ–¹å¼æ¥å­˜å‚¨ã€‚

## httpå¹¶å‘ä¸Šä¼ å¤§æ–‡ä»¶åˆ‡ç‰‡

ä¿®æ”¹`file_slice.html`æ–‡ä»¶ï¼š

```html
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
	</head>
	<body>
		<input type="file" id="file">
		<script>
			// è¯·æ±‚å°è£…
			// httpå¹¶å‘æ–‡ä»¶ä¸Šä¼  blobä¸Šä¼  chunk POST
			// å½“blob Promise.All å†å‘é€ä¸€ä¸ªmergeçš„è¯·æ±‚ /merge
			function request({
				url,
				method = 'POST',
				data,
				headers = {},
				requestList // ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨
			}) {
				return new Promise(resolve => {
					const xhr = new XMLHttpRequest(); // js ajax å¯¹è±¡
					xhr.open(method, url); // è¯·æ±‚
					Object.keys(headers).forEach(key => {
						xhr.setRequestHeader(key, headers[key]) // è¯·æ±‚åŠ å¤´ä¿¡æ¯
					})
					xhr.send(data);
					xhr.onload = e => {
						// äº‹ä»¶ç›‘å¬
						resolve({
							data: e.target.response
						})
					}
				})
			}

			document.getElementById('file')
			.addEventListener('change', async (event) => {
				const file = event.target.files[0]; // es6 æ–‡ä»¶å¯¹è±¡
				// console.log(file);
				const file_name = file.name.split('.')[0];
				// console.log(Object.prototype.toString.call(file)); // [object File]
				// console.log(Object.prototype.toString.call(file.slice(0, 102400))); // [object Blob]
				let cur = 0, size = 1024*1024; // 1M
				// blobç­‰å¾…ä¸Šä¼ çš„å¯¹è±¡ï¼Œæ‰€æœ‰çš„åˆ‡ç‰‡ä¸Šä¼ å®Œ
				const fileChunkList = []; // blobæ•°ç»„
				while(cur < file.size) {
					fileChunkList.push({
						// cur start offset end
						file: file.slice(cur, cur + size)
					});
					cur += size;
				}
				console.log(fileChunkList)
				const requestList = fileChunkList.map(({file}, index) => {
					// è¯·æ±‚çš„æ•°ç»„
					const formData = new FormData(); // js post form
					formData.append('chunk', file);
					formData.append('filename', `${file_name}-${index}`);
					return {
						formData
					};
				})
				.map(async ({ formData }) => request({
					 url: 'http://localhost:3000', // å‰åç«¯çš„api
						data: formData
					}))
				await Promise.all(requestList); // å¹¶å‘å§
				// console.log(requestList);
			})
		</script>
	</body>
</html>
```

`server`ç›®å½•ä¸‹ï¼Œåˆ›å»º`main.js`æ–‡ä»¶ï¼Œå¤„ç†æäº¤:

- ä¸‹è½½`yarn add multiparty`

```js
const http = require('http');
const path = require('path');
const multiparty = require('multiparty');
const fse = require('fs-extra');
const server = http.createServer();

const UPLOAD_DIR = path.resolve(__dirname, '.', 'target');

server.on('request', async (req, res) => {
 res.setHeader("Access-Control-Allow-Origin", "*");
 res.setHeader("Access-Control-Allow-Headers", "*");
 // res.end("hello");

 if (req.url == '/') {
  // chunk, name
  const multipart = new multiparty.Form();
  // console.log(multipart)
  multipart.parse(req, async (err, fields, files) => {
   if (err) {
    return;
   }
   // console.log(files);

   const [chunk] = files.chunk; // æ‹¿åˆ°äº†æ–‡ä»¶å—
   const [filename] = fields.filename; // æ–‡ä»¶å
   // å—å
   // console.log(filename);

   const dir_name = filename.split('-')[0];
   const chunkDir = path.resolve(UPLOAD_DIR, dir_name);
   if (!fse.existsSync(chunkDir)) {
    await fse.mkdirs(chunkDir)
   }
   // chunk.path
   // æŠŠchunkæ”¾å…¥ç›®å½•
   await fse.move(chunk.path, `${chunkDir}/${filename}`);
  })
 } else if (req.url == '/merge/') {
  // åˆå¹¶
  res.end('OK');
 }
})

server.listen(3000, () => console.log('æ­£åœ¨ç›‘å¬3000ç«¯å£'))
```

```js
Form {
  _writableState: WritableState {
    objectMode: false,
    highWaterMark: 16384,
    finalCalled: false,
    needDrain: false,
    ending: false,
    ended: false,
    finished: false,
    destroyed: false,
    decodeStrings: true,
    defaultEncoding: 'utf8',
    length: 0,
    writing: false,
    corked: 0,
    sync: true,
    bufferProcessing: false,
    onwrite: [Function: bound onwrite],
    writecb: null,
    writelen: 0,
    afterWriteTickInfo: null,
    buffered: [],
    bufferedIndex: 0,
    allBuffers: true,
    allNoop: true,
    pendingcb: 0,
    prefinished: false,
    errorEmitted: false,
    emitClose: false,
    autoDestroy: true,
    errored: null,
    closed: false
  },
  _events: [Object: null prototype] { newListener: [Function (anonymous)] },
  _eventsCount: 1,
  _maxListeners: undefined,
  error: null,
  autoFields: false,
  autoFiles: false,
  maxFields: 1000,
  maxFieldsSize: 2097152,
  maxFilesSize: Infinity,
  uploadDir: 'C:\\Users\\xxx\\xxx\\Local\\xxx',
  encoding: 'utf8',
  bytesReceived: 0,
  bytesExpected: null,
  openedFiles: [],
  totalFieldSize: 0,
  totalFieldCount: 0,
  totalFileSize: 0,
  flushing: 0,
  backpressure: false,
  writeCbs: [],
  emitQueue: [],
  [Symbol(kCapture)]: false
}
```

## æ–­ç‚¹ç»­ä¼ 

1. æœåŠ¡å™¨ç«¯è¿”å›ï¼Œå‘ŠçŸ¥æˆ‘ä»é‚£å¼€å§‹
2. æµè§ˆå™¨ç«¯è‡ªè¡Œå¤„ç†

> ç¼“å­˜å¤„ç†

1. åœ¨åˆ‡ç‰‡ä¸Šä¼ çš„`axios`æˆåŠŸå›è°ƒä¸­ï¼Œå­˜å‚¨å·²ä¸Šä¼ æˆåŠŸçš„åˆ‡ç‰‡
2. åœ¨åˆ‡ç‰‡ä¸Šä¼ å‰ï¼Œå…ˆçœ‹ä¸‹`localstorage`ä¸­æ˜¯å¦å­˜åœ¨å·²ä¸Šä¼ çš„åˆ‡ç‰‡,å¹¶ä¿®æ”¹`uploaded`
3. æ„é€ åˆ‡ç‰‡æ•°æ®æ—¶ï¼Œè¿‡æ»¤æ‰`uploaded`ä¸º`true`çš„

> åƒåœ¾æ–‡ä»¶æ¸…ç†

1. å‰ç«¯åœ¨localstorageè®¾ç½®ç¼“å­˜æ—¶é—´ï¼Œè¶…è¿‡æ—¶é—´å°±å‘é€è¯·æ±‚é€šçŸ¥åç«¯æ¸…ç†ç¢ç‰‡æ–‡ä»¶ï¼ŒåŒæ—¶å‰ç«¯ä¹Ÿè¦æ¸…ç†ç¼“å­˜ã€‚
2. å‰åç«¯éƒ½çº¦å®šå¥½ï¼Œæ¯ä¸ªç¼“å­˜ä»ç”Ÿæˆå¼€å§‹ï¼Œåªèƒ½å­˜å‚¨12å°æ—¶ï¼Œ12å°æ—¶åè‡ªåŠ¨æ¸…ç†

1. ä¸ºæ¯ä¸ªæ–‡ä»¶åˆ‡å‰²å—æ·»åŠ ä¸åŒçš„æ ‡è¯†, `hash`
2. å½“ä¸Šä¼ æˆåŠŸåï¼Œè®°å½•ä¸Šä¼ æˆåŠŸçš„æ ‡è¯†
3. å½“æˆ‘ä»¬æš‚åœæˆ–è€…å‘é€å¤±è´¥åï¼Œå¯ä»¥é‡æ–°å‘é€æ²¡æœ‰ä¸Šä¼ æˆåŠŸçš„åˆ‡å‰²æ–‡ä»¶

åˆ›å»ºvueé¡¹ç›®ï¼š`vue create vue-upload-big-file`.

```js
$ vue --version
@vue/cli 4.5.13
vue create vue-upload-big-file

$ vue create vue-upload-big-file
? Please pick a preset: (Use arrow keys)
? Please pick a preset: Manually select features
? Check the features needed for your project: (Press <space> to select, <a> to t
? Check the features needed for your project: Choose Vue version, Babel
? Choose a version of Vue.js that you want to start the project with (Use arrow
? Choose a version of Vue.js that you want to start the project with 2.x
? Where do you prefer placing config for Babel, ESLint, etc.? (Use arrow keys)
> In dedicated config files
? Where do you prefer placing config for Babel, ESLint, etc.? In package.json
? Save this as a preset for future projects? (y/N) n

yarn add element-ui
```

åœ¨`main.js`ä¸­å¼•å…¥`element-ui`,ä»£ç å¦‚ä¸‹ï¼š

```js
import Vue from 'vue
import App from './App.vue'
import ElementUI from 'element-ui
import 'element-ui/lib/theme-chalk/index.css'

Vue.use(ElementUI);

Vue.config.productionTip = false

new Vue({
 render: h => h(App),
 }).$mount('#app')
```

`App.vue`ä»£ç æ¸…ç†å¦‚ä¸‹ï¼š

```js
<template>
 <div id="app">
 </div>
</template>

<script>
export default {
 name: 'app',
 components: {
 }
}
</script>
```

`App.vue`ä»£ç å®ç°ï¼š

```js
async calculateHash (fileChunkList) {
 return new Promise(resolve => {
  // éœ€è¦èŠ±æ—¶é—´çš„ä»»åŠ¡
  // web workers
  // js å•çº¿ç¨‹çš„ UI çº¿ç¨‹
  // html5 web workers å•ç‹¬å¼€ä¸€ä¸ªçº¿ç¨‹ ç‹¬ç«‹äº worker
  // å›è°ƒ
  this.container.worker = new Worker('/hash.js');
  this.container.worker.postMessage({ fileChunkList });
  this.container.worker.onmessage = e => {
   console.log(e.data);
  }
 })
}

async handleUpload (e) {
 // å¤§é‡çš„ä»»åŠ¡
 if (!this.container.file) return;
 this.status = Status.uploading;
 const fileChunkList = this.createFileCHunk(this.container,file);
 this.container.hash = await this.calculateHash(fileChunkList);
}

createFileCHunk (file, size = SIZE) {
 const fileChunkList = [];
 let cur = 0;
 while (cur < file.size) {
  fileChunkList.push({
   file: file.slice(cur, cur + size)
  });
  cur += size;
 }
 return fileChunkList;
}

handleFileChange(e) {
 // åˆ†éš”æ–‡ä»¶
 const [ file ] = e.target.files; // æ‹¿åˆ°ç¬¬ä¸€ä¸ªæ–‡ä»¶
 // console.log(e.target.files);
 this.container.file = file;
}
```

æ— è®ºæ—¶å‰ç«¯è¿˜æ˜¯åç«¯ï¼Œè¦è€ƒè™‘ä¼ è¾“æ–‡ä»¶ï¼Œç‰¹åˆ«æ˜¯å¤§æ–‡ä»¶ï¼Œæœ‰å¯èƒ½å‘ç”Ÿä¸¢å¤±æ–‡ä»¶çš„æƒ…å†µï¼Œç½‘é€Ÿå¡é¡¿ï¼ŒæœåŠ¡å™¨è¶…æ—¶ï¼Œå¦‚ä½•é¿å…ä¸¢å¤±çš„æƒ…å†µã€‚`hash`

å½“ç‚¹å‡»ä¸Šä¼ æŒ‰é’®æ—¶å€™ï¼Œè°ƒç”¨`createFileChunk`å°†æ–‡ä»¶è¿›è¡Œåˆ‡ç‰‡ï¼Œåˆ‡ç‰‡æ•°é‡é€šè¿‡æ–‡ä»¶å¤§å°æ§åˆ¶ï¼Œè¿™é‡Œè®¾ç½®é»˜è®¤å€¼å¤§å°ï¼Œè¿›è¡Œé»˜è®¤å€¼å¤§å°çš„è¿›è¡Œåˆ‡ç‰‡

`createFileChunk`å†…ä½¿ç”¨`while`å¾ªç¯å’Œ`slice`æ–¹æ³•å°†åˆ‡ç‰‡æ”¾å…¥`fileChunkList`æ•°ç»„ä¸­è¿”å›

åœ¨ç”Ÿæˆæ–‡ä»¶åˆ‡ç‰‡æ—¶ï¼Œéœ€è¦ç»™æ¯ä¸ªåˆ‡ç‰‡ä¸€ä¸ªæ ‡è¯†ä½œä¸º`hash`ï¼Œè¿™é‡Œä½¿ç”¨æ–‡ä»¶å+ä¸‹æ ‡ï¼Œè¿™æ ·åç«¯å¯ä»¥çŸ¥é“åˆ‡ç‰‡æ˜¯ç¬¬å‡ ä¸ªåˆ‡ç‰‡ï¼Œç”¨äºä¹‹åçš„åˆå¹¶åˆ‡ç‰‡

## FormData.append()

å‘é€æ•°æ®ç”¨åˆ°äº† `FormData`

`formData.append(name, value, filename)`ï¼Œå…¶ä¸­ `filename` ä¸ºå¯é€‰å‚æ•°ï¼Œæ˜¯ä¼ ç»™æœåŠ¡å™¨çš„æ–‡ä»¶åç§°ï¼Œ å½“ä¸€ä¸ª `Blob æˆ– File` è¢«ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°çš„æ—¶å€™ï¼Œ `Blob` å¯¹è±¡çš„é»˜è®¤æ–‡ä»¶åæ˜¯ `"blob"`ã€‚ 

## ä»€ä¹ˆå«hashå‘¢

ä»€ä¹ˆå«`hash`å‘¢ï¼Ÿæ–‡ä»¶åï¼Œå¹¶ä¸æ˜¯å”¯ä¸€çš„ï¼Œ`1.jpg`å›¾ç‰‡ï¼Œ`1.jpg`å›¾ç‰‡ï¼Œæˆ– `2.jpg`å›¾ç‰‡ ä¸€æ ·çš„å†…å®¹ã€‚- ä¸åŒåçš„å›¾ç‰‡ï¼Œå†…å®¹æ˜¯ä¸€æ ·çš„ã€‚é’ˆå¯¹æ–‡ä»¶å†…å®¹è¿›è¡Œ `hash`è®¡ç®—ã€‚ä¸¢å¤±é‡ä¼ ã€‚

éšåè°ƒç”¨`uploadChunks`ä¸Šä¼ æ‰€æœ‰çš„æ–‡ä»¶åˆ‡ç‰‡ï¼Œå°†æ–‡ä»¶åˆ‡ç‰‡ï¼Œåˆ‡ç‰‡`hash`ï¼Œä»¥åŠæ–‡ä»¶åæ”¾å…¥`FormData`ä¸­ï¼Œå†è°ƒç”¨ä¸Šä¸€æ­¥çš„ `request` å‡½æ•°è¿”å›ä¸€ä¸ª `promise`ï¼Œæœ€åè°ƒç”¨ `Promise.all`å¹¶å‘ä¸Šä¼ æ‰€æœ‰çš„åˆ‡ç‰‡

`spark-md5.min.js`:

```js
(function(factory){if(typeof exports==="object"){module.exports=factory()}else if(typeof define==="function"&&define.amd){define(factory)}else{var glob;try{glob=window}catch(e){glob=self}glob.SparkMD5=factory()}})(function(undefined){"use strict";var add32=function(a,b){return a+b&4294967295},hex_chr=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function cmn(q,a,b,x,s,t){a=add32(add32(a,q),add32(x,t));return add32(a<<s|a>>>32-s,b)}function md5cycle(x,k){var a=x[0],b=x[1],c=x[2],d=x[3];a+=(b&c|~b&d)+k[0]-680876936|0;a=(a<<7|a>>>25)+b|0;d+=(a&b|~a&c)+k[1]-389564586|0;d=(d<<12|d>>>20)+a|0;c+=(d&a|~d&b)+k[2]+606105819|0;c=(c<<17|c>>>15)+d|0;b+=(c&d|~c&a)+k[3]-1044525330|0;b=(b<<22|b>>>10)+c|0;a+=(b&c|~b&d)+k[4]-176418897|0;a=(a<<7|a>>>25)+b|0;d+=(a&b|~a&c)+k[5]+1200080426|0;d=(d<<12|d>>>20)+a|0;c+=(d&a|~d&b)+k[6]-1473231341|0;c=(c<<17|c>>>15)+d|0;b+=(c&d|~c&a)+k[7]-45705983|0;b=(b<<22|b>>>10)+c|0;a+=(b&c|~b&d)+k[8]+1770035416|0;a=(a<<7|a>>>25)+b|0;d+=(a&b|~a&c)+k[9]-1958414417|0;d=(d<<12|d>>>20)+a|0;c+=(d&a|~d&b)+k[10]-42063|0;c=(c<<17|c>>>15)+d|0;b+=(c&d|~c&a)+k[11]-1990404162|0;b=(b<<22|b>>>10)+c|0;a+=(b&c|~b&d)+k[12]+1804603682|0;a=(a<<7|a>>>25)+b|0;d+=(a&b|~a&c)+k[13]-40341101|0;d=(d<<12|d>>>20)+a|0;c+=(d&a|~d&b)+k[14]-1502002290|0;c=(c<<17|c>>>15)+d|0;b+=(c&d|~c&a)+k[15]+1236535329|0;b=(b<<22|b>>>10)+c|0;a+=(b&d|c&~d)+k[1]-165796510|0;a=(a<<5|a>>>27)+b|0;d+=(a&c|b&~c)+k[6]-1069501632|0;d=(d<<9|d>>>23)+a|0;c+=(d&b|a&~b)+k[11]+643717713|0;c=(c<<14|c>>>18)+d|0;b+=(c&a|d&~a)+k[0]-373897302|0;b=(b<<20|b>>>12)+c|0;a+=(b&d|c&~d)+k[5]-701558691|0;a=(a<<5|a>>>27)+b|0;d+=(a&c|b&~c)+k[10]+38016083|0;d=(d<<9|d>>>23)+a|0;c+=(d&b|a&~b)+k[15]-660478335|0;c=(c<<14|c>>>18)+d|0;b+=(c&a|d&~a)+k[4]-405537848|0;b=(b<<20|b>>>12)+c|0;a+=(b&d|c&~d)+k[9]+568446438|0;a=(a<<5|a>>>27)+b|0;d+=(a&c|b&~c)+k[14]-1019803690|0;d=(d<<9|d>>>23)+a|0;c+=(d&b|a&~b)+k[3]-187363961|0;c=(c<<14|c>>>18)+d|0;b+=(c&a|d&~a)+k[8]+1163531501|0;b=(b<<20|b>>>12)+c|0;a+=(b&d|c&~d)+k[13]-1444681467|0;a=(a<<5|a>>>27)+b|0;d+=(a&c|b&~c)+k[2]-51403784|0;d=(d<<9|d>>>23)+a|0;c+=(d&b|a&~b)+k[7]+1735328473|0;c=(c<<14|c>>>18)+d|0;b+=(c&a|d&~a)+k[12]-1926607734|0;b=(b<<20|b>>>12)+c|0;a+=(b^c^d)+k[5]-378558|0;a=(a<<4|a>>>28)+b|0;d+=(a^b^c)+k[8]-2022574463|0;d=(d<<11|d>>>21)+a|0;c+=(d^a^b)+k[11]+1839030562|0;c=(c<<16|c>>>16)+d|0;b+=(c^d^a)+k[14]-35309556|0;b=(b<<23|b>>>9)+c|0;a+=(b^c^d)+k[1]-1530992060|0;a=(a<<4|a>>>28)+b|0;d+=(a^b^c)+k[4]+1272893353|0;d=(d<<11|d>>>21)+a|0;c+=(d^a^b)+k[7]-155497632|0;c=(c<<16|c>>>16)+d|0;b+=(c^d^a)+k[10]-1094730640|0;b=(b<<23|b>>>9)+c|0;a+=(b^c^d)+k[13]+681279174|0;a=(a<<4|a>>>28)+b|0;d+=(a^b^c)+k[0]-358537222|0;d=(d<<11|d>>>21)+a|0;c+=(d^a^b)+k[3]-722521979|0;c=(c<<16|c>>>16)+d|0;b+=(c^d^a)+k[6]+76029189|0;b=(b<<23|b>>>9)+c|0;a+=(b^c^d)+k[9]-640364487|0;a=(a<<4|a>>>28)+b|0;d+=(a^b^c)+k[12]-421815835|0;d=(d<<11|d>>>21)+a|0;c+=(d^a^b)+k[15]+530742520|0;c=(c<<16|c>>>16)+d|0;b+=(c^d^a)+k[2]-995338651|0;b=(b<<23|b>>>9)+c|0;a+=(c^(b|~d))+k[0]-198630844|0;a=(a<<6|a>>>26)+b|0;d+=(b^(a|~c))+k[7]+1126891415|0;d=(d<<10|d>>>22)+a|0;c+=(a^(d|~b))+k[14]-1416354905|0;c=(c<<15|c>>>17)+d|0;b+=(d^(c|~a))+k[5]-57434055|0;b=(b<<21|b>>>11)+c|0;a+=(c^(b|~d))+k[12]+1700485571|0;a=(a<<6|a>>>26)+b|0;d+=(b^(a|~c))+k[3]-1894986606|0;d=(d<<10|d>>>22)+a|0;c+=(a^(d|~b))+k[10]-1051523|0;c=(c<<15|c>>>17)+d|0;b+=(d^(c|~a))+k[1]-2054922799|0;b=(b<<21|b>>>11)+c|0;a+=(c^(b|~d))+k[8]+1873313359|0;a=(a<<6|a>>>26)+b|0;d+=(b^(a|~c))+k[15]-30611744|0;d=(d<<10|d>>>22)+a|0;c+=(a^(d|~b))+k[6]-1560198380|0;c=(c<<15|c>>>17)+d|0;b+=(d^(c|~a))+k[13]+1309151649|0;b=(b<<21|b>>>11)+c|0;a+=(c^(b|~d))+k[4]-145523070|0;a=(a<<6|a>>>26)+b|0;d+=(b^(a|~c))+k[11]-1120210379|0;d=(d<<10|d>>>22)+a|0;c+=(a^(d|~b))+k[2]+718787259|0;c=(c<<15|c>>>17)+d|0;b+=(d^(c|~a))+k[9]-343485551|0;b=(b<<21|b>>>11)+c|0;x[0]=a+x[0]|0;x[1]=b+x[1]|0;x[2]=c+x[2]|0;x[3]=d+x[3]|0}function md5blk(s){var md5blks=[],i;for(i=0;i<64;i+=4){md5blks[i>>2]=s.charCodeAt(i)+(s.charCodeAt(i+1)<<8)+(s.charCodeAt(i+2)<<16)+(s.charCodeAt(i+3)<<24)}return md5blks}function md5blk_array(a){var md5blks=[],i;for(i=0;i<64;i+=4){md5blks[i>>2]=a[i]+(a[i+1]<<8)+(a[i+2]<<16)+(a[i+3]<<24)}return md5blks}function md51(s){var n=s.length,state=[1732584193,-271733879,-1732584194,271733878],i,length,tail,tmp,lo,hi;for(i=64;i<=n;i+=64){md5cycle(state,md5blk(s.substring(i-64,i)))}s=s.substring(i-64);length=s.length;tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;i<length;i+=1){tail[i>>2]|=s.charCodeAt(i)<<(i%4<<3)}tail[i>>2]|=128<<(i%4<<3);if(i>55){md5cycle(state,tail);for(i=0;i<16;i+=1){tail[i]=0}}tmp=n*8;tmp=tmp.toString(16).match(/(.*?)(.{0,8})$/);lo=parseInt(tmp[2],16);hi=parseInt(tmp[1],16)||0;tail[14]=lo;tail[15]=hi;md5cycle(state,tail);return state}function md51_array(a){var n=a.length,state=[1732584193,-271733879,-1732584194,271733878],i,length,tail,tmp,lo,hi;for(i=64;i<=n;i+=64){md5cycle(state,md5blk_array(a.subarray(i-64,i)))}a=i-64<n?a.subarray(i-64):new Uint8Array(0);length=a.length;tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;i<length;i+=1){tail[i>>2]|=a[i]<<(i%4<<3)}tail[i>>2]|=128<<(i%4<<3);if(i>55){md5cycle(state,tail);for(i=0;i<16;i+=1){tail[i]=0}}tmp=n*8;tmp=tmp.toString(16).match(/(.*?)(.{0,8})$/);lo=parseInt(tmp[2],16);hi=parseInt(tmp[1],16)||0;tail[14]=lo;tail[15]=hi;md5cycle(state,tail);return state}function rhex(n){var s="",j;for(j=0;j<4;j+=1){s+=hex_chr[n>>j*8+4&15]+hex_chr[n>>j*8&15]}return s}function hex(x){var i;for(i=0;i<x.length;i+=1){x[i]=rhex(x[i])}return x.join("")}if(hex(md51("hello"))!=="5d41402abc4b2a76b9719d911017c592"){add32=function(x,y){var lsw=(x&65535)+(y&65535),msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|lsw&65535}}if(typeof ArrayBuffer!=="undefined"&&!ArrayBuffer.prototype.slice){(function(){function clamp(val,length){val=val|0||0;if(val<0){return Math.max(val+length,0)}return Math.min(val,length)}ArrayBuffer.prototype.slice=function(from,to){var length=this.byteLength,begin=clamp(from,length),end=length,num,target,targetArray,sourceArray;if(to!==undefined){end=clamp(to,length)}if(begin>end){return new ArrayBuffer(0)}num=end-begin;target=new ArrayBuffer(num);targetArray=new Uint8Array(target);sourceArray=new Uint8Array(this,begin,num);targetArray.set(sourceArray);return target}})()}function toUtf8(str){if(/[\u0080-\uFFFF]/.test(str)){str=unescape(encodeURIComponent(str))}return str}function utf8Str2ArrayBuffer(str,returnUInt8Array){var length=str.length,buff=new ArrayBuffer(length),arr=new Uint8Array(buff),i;for(i=0;i<length;i+=1){arr[i]=str.charCodeAt(i)}return returnUInt8Array?arr:buff}function arrayBuffer2Utf8Str(buff){return String.fromCharCode.apply(null,new Uint8Array(buff))}function concatenateArrayBuffers(first,second,returnUInt8Array){var result=new Uint8Array(first.byteLength+second.byteLength);result.set(new Uint8Array(first));result.set(new Uint8Array(second),first.byteLength);return returnUInt8Array?result:result.buffer}function hexToBinaryString(hex){var bytes=[],length=hex.length,x;for(x=0;x<length-1;x+=2){bytes.push(parseInt(hex.substr(x,2),16))}return String.fromCharCode.apply(String,bytes)}function SparkMD5(){this.reset()}SparkMD5.prototype.append=function(str){this.appendBinary(toUtf8(str));return this};SparkMD5.prototype.appendBinary=function(contents){this._buff+=contents;this._length+=contents.length;var length=this._buff.length,i;for(i=64;i<=length;i+=64){md5cycle(this._hash,md5blk(this._buff.substring(i-64,i)))}this._buff=this._buff.substring(i-64);return this};SparkMD5.prototype.end=function(raw){var buff=this._buff,length=buff.length,i,tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],ret;for(i=0;i<length;i+=1){tail[i>>2]|=buff.charCodeAt(i)<<(i%4<<3)}this._finish(tail,length);ret=hex(this._hash);if(raw){ret=hexToBinaryString(ret)}this.reset();return ret};SparkMD5.prototype.reset=function(){this._buff="";this._length=0;this._hash=[1732584193,-271733879,-1732584194,271733878];return this};SparkMD5.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash}};SparkMD5.prototype.setState=function(state){this._buff=state.buff;this._length=state.length;this._hash=state.hash;return this};SparkMD5.prototype.destroy=function(){delete this._hash;delete this._buff;delete this._length};SparkMD5.prototype._finish=function(tail,length){var i=length,tmp,lo,hi;tail[i>>2]|=128<<(i%4<<3);if(i>55){md5cycle(this._hash,tail);for(i=0;i<16;i+=1){tail[i]=0}}tmp=this._length*8;tmp=tmp.toString(16).match(/(.*?)(.{0,8})$/);lo=parseInt(tmp[2],16);hi=parseInt(tmp[1],16)||0;tail[14]=lo;tail[15]=hi;md5cycle(this._hash,tail)};SparkMD5.hash=function(str,raw){return SparkMD5.hashBinary(toUtf8(str),raw)};SparkMD5.hashBinary=function(content,raw){var hash=md51(content),ret=hex(hash);return raw?hexToBinaryString(ret):ret};SparkMD5.ArrayBuffer=function(){this.reset()};SparkMD5.ArrayBuffer.prototype.append=function(arr){var buff=concatenateArrayBuffers(this._buff.buffer,arr,true),length=buff.length,i;this._length+=arr.byteLength;for(i=64;i<=length;i+=64){md5cycle(this._hash,md5blk_array(buff.subarray(i-64,i)))}this._buff=i-64<length?new Uint8Array(buff.buffer.slice(i-64)):new Uint8Array(0);return this};SparkMD5.ArrayBuffer.prototype.end=function(raw){var buff=this._buff,length=buff.length,tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],i,ret;for(i=0;i<length;i+=1){tail[i>>2]|=buff[i]<<(i%4<<3)}this._finish(tail,length);ret=hex(this._hash);if(raw){ret=hexToBinaryString(ret)}this.reset();return ret};SparkMD5.ArrayBuffer.prototype.reset=function(){this._buff=new Uint8Array(0);this._length=0;this._hash=[1732584193,-271733879,-1732584194,271733878];return this};SparkMD5.ArrayBuffer.prototype.getState=function(){var state=SparkMD5.prototype.getState.call(this);state.buff=arrayBuffer2Utf8Str(state.buff);return state};SparkMD5.ArrayBuffer.prototype.setState=function(state){state.buff=utf8Str2ArrayBuffer(state.buff,true);return SparkMD5.prototype.setState.call(this,state)};SparkMD5.ArrayBuffer.prototype.destroy=SparkMD5.prototype.destroy;SparkMD5.ArrayBuffer.prototype._finish=SparkMD5.prototype._finish;SparkMD5.ArrayBuffer.hash=function(arr,raw){var hash=md51_array(new Uint8Array(arr)),ret=hex(hash);return raw?hexToBinaryString(ret):ret};return SparkMD5});
```

```js
('/hash.js') // æ”¾åœ¨æ ¹ç›®å½• public
```

`web workers` ä¼˜åŒ–æˆ‘ä»¬çš„å‰ç«¯æ€§èƒ½ï¼Œå°†è¦èŠ±å¤§é‡æ—¶é—´çš„ï¼Œå¤æ‚çš„ï¼Œæ”¾åˆ°ä¸€ä¸ªæ–°çš„çº¿ç¨‹ä¸­å»è®¡ç®—ï¼Œæ–‡ä»¶ä¸Šä¼ é€šè¿‡`hash`è®¡ç®—ã€‚


`hash.js`ä»£ç :

```js
// é€šè¿‡å†…å®¹è®¡ç®—md5å€¼
self.importScripts('/spark-md5.min.js')

self.onmessage = e => {
	// self.postMessage({
	// 	"msg": "æ‚¨å¥½"
	// })
	const { fileChunkList } = e.data;
	const spark = new self.SparkMD5.ArrayBuffer();
	let percentage = 0;
	let count = 0;
	// console.log(fileChunkList, 'worker fileChunkList');
	// è®¡ç®—å‡ºhash
	const loadNext = index => {
		const reader = new FileReader(); // æ–‡ä»¶é˜…è¯»å¯¹è±¡
		reader.readAsArrayBuffer(fileChunkList[index].file);
		reader.onload = e => { // äº‹ä»¶
			count++;
			spark.append(e.target.result);
			if (count === fileChunkList.length)
			{
				self.postMessage({
					percentage: 100,
					hash: spark.end()
				});
				self.close(); // å…³é—­å½“å‰çº¿ç¨‹
			} else {
				// è¿˜æ²¡è¯»å®Œ
				percentage += 100/fileChunkList.length;
				self.postMessage({
					percentage
				});
				loadNext(count);
			}
		}
	}
	loadNext(0)
} // this å½“å‰çš„çº¿ç¨‹
```

## å¤§æ–‡ä»¶ä¸Šä¼ 

1. å°†å¤§æ–‡ä»¶è½¬æ¢ä¸ºäºŒè¿›åˆ¶æµçš„æ ¼å¼
2. åˆ©ç”¨æµå¯ä»¥åˆ‡å‰²çš„å±æ€§ï¼Œå°†äºŒè¿›åˆ¶æµåˆ‡å‰²æˆå¤šä»½
3. ç»„è£…å’Œåˆ†å‰²å—åŒç­‰æ•°é‡çš„è¯·æ±‚å—ï¼Œå¹¶è¡Œæˆ–ä¸²è¡Œçš„å½¢å¼å‘å‡ºè¯·æ±‚
4. å†ç»™æœåŠ¡å™¨ç«¯å‘å‡ºä¸€ä¸ªåˆå¹¶çš„ä¿¡æ¯

## App.vue

```js
<template>
	<div id="app">
		<div>
			<input type="file" :disabled="status !== Status.wait" @change="handleFileChange" />
			<el-button @click="handleUpload" :disabled="uploadDisabled">ä¸Šä¼ </el-button>
			<el-button @click="handleResume" v-if="status === Status.pause">æ¢å¤</el-button>
			<el-button v-else :disabled="status !== Status.uploading || !container.hash" @click="handlePause">æš‚åœ
			</el-button>
		</div>
		<div>
			<div>è®¡ç®—æ–‡ä»¶hash</div>
			<el-progress :percentage="hashPercentage"></el-progress>
			<div>æ€»è¿›åº¦</div>
			<!-- æ¯ä¸ªblob è¿›åº¦ è®¡ç®—å‡ºæ¥ï¼Ÿ 
      1. æ¯å—blob ä¸Šä¼   å€¼percentage å˜çš„ï¼Œ watch 
      2. è®¡ç®—å±æ€§ computed -->
			<el-progress :percentage="fakeUploadPercentage"></el-progress>
		</div>
		<!-- å¤šä¸ªåˆ‡ç‰‡  -->
		<!-- [{a:1}] -->
		<el-table :data="data">
			<el-table-column prop="hash" label="åˆ‡ç‰‡hash" align="center">
			</el-table-column>
			<el-table-column label="å¤§å°(kb)" align="center" width="120">
				<template v-slot="{row}">
					{{row.size | transformByte}}
				</template>
			</el-table-column>
			<el-table-column label="è¿›åº¦" align="center">
				<template v-slot="{row}">
					<el-progress :percentage="row.percentage" color="#909399">
					</el-progress>
				</template>
			</el-table-column>
		</el-table>
	</div>
</template>

<script>
	const SIZE = 10 * 1024 * 1024; // åˆ‡ç‰‡å¤§å°
	const Status = {
		wait: "wait",
		pause: "pause",
		uploading: "uploading"
	};

	export default {
		name: 'app',
		filters: {
			transformByte(val) {
				return Number((val / 1024).toFixed(0))
			}
		},
		computed: {
			uploadDisabled() {
				return (
					!this.container.file || [Status.pause, Status.uploading].includes(this.status)
				);
			},
			uploadPercentage() {
				if (!this.container.file || !this.data.length) return 0;
				const loaded = this.data
					.map(item => item.size * item.percentage)
					.reduce((acc, cur) => acc + cur);
				return parseInt((loaded / this.container.file.size).toFixed(2));
			}
		},
		watch: {
			uploadPercentage(now) {
				if (now > this.fakeUploadPercentage) {
					this.fakeUploadPercentage = now;
				}
			}
		},
		data: () => ({
			Status,
			container: {
				file: null,
				hash: "",
				worker: null
			},
			hashPercentage: 0,
			data: [],
			requestList: [],
			status: Status.wait,
			// å½“æš‚åœæ—¶ä¼šå–æ¶ˆ xhr å¯¼è‡´è¿›åº¦æ¡åé€€
			// ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ªå‡çš„è¿›åº¦æ¡
			fakeUploadPercentage: 0
		}),
		methods: {
			async handleResume() {
				this.status = Status.uploading;
				const {
					uploadedList
				} = await this.verifyUpload(
					this.container.file.name,
					this.container.hash
				)
				await this.uploadChunks(uploadedList);
			},
			handlePause() {
				this.status = Status.pause; // çŠ¶æ€åœ
				this.resetData();
			},
			resetData() {
				this.requestList.forEach(xhr => xhr.abort())
				this.requestList = [];
				if (this.container.worker) { //hash è®¡ç®—è¿‡ç¨‹ä¸­
					this.container.worker.onmessage = null;
				}
			},
			// xhr
			request({
				url,
				method = "post",
				data,
				headers = {},
				onProgress = e => e,
				requestList
			}) {
				return new Promise(resolve => {
					const xhr = new XMLHttpRequest();
					xhr.upload.onprogress = onProgress;
					xhr.open(method, url);
					Object.keys(headers).forEach(key =>
						xhr.setRequestHeader(key, headers[key])
					);
					xhr.send(data);
					xhr.onload = e => {
						// å°†è¯·æ±‚æˆåŠŸçš„ xhr ä»åˆ—è¡¨ä¸­åˆ é™¤
						if (requestList) {
							const xhrIndex = requestList.findIndex(item => item === xhr);
							requestList.splice(xhrIndex, 1);
						}
						resolve({
							data: e.target.response
						});
					};
					// æš´éœ²å½“å‰ xhr ç»™å¤–éƒ¨
					requestList?.push(xhr);
				});
			},
			async calculateHash(fileChunkList) {
				return new Promise(resolve => {
					// å°è£…èŠ±æ—¶é—´çš„ä»»åŠ¡
					// web workers   
					// js å•çº¿ç¨‹çš„ UI ä¸»çº¿ç¨‹ 
					// html5 web workers å•ç‹¬å¼€ä¸€ä¸ªçº¿ç¨‹ ç‹¬ç«‹äº worker
					// å›è°ƒ ä¸ä¼šå½±å“åŸæ¥çš„UI 
					// html5 å¸¦æ¥çš„ä¼˜åŒ–ï¼Œ 
					this.container.worker = new Worker("/hash.js");
					this.container.worker.postMessage({
						fileChunkList
					});
					this.container.worker.onmessage = e => {
						// console.log(e.data);
						const {
							percentage,
							hash
						} = e.data;
						console.log(percentage, '----');
						this.hashPercentage = percentage;
						if (hash) {
							resolve(hash);
						}

					}
				})
			},
			async handleUpload(e) {
				// å¤§é‡çš„ä»»åŠ¡
				if (!this.container.file) return;
				this.status = Status.uploading;
				const fileChunkList = this.createFileChunk(this.container.file);
				console.log(fileChunkList);
				this.container.hash = await this.calculateHash(fileChunkList);
				// æ–‡ä»¶ hash  æ²¡å¿…è¦ä¸Šä¼ åŒä¸€ä¸ªæ–‡ä»¶å¤šæ¬¡
				const {
					shouldUpload,
					uploadedList
				} = await this.verifyUpload( //ä¸Šä¼ ï¼Œ éªŒè¯
					this.container.file.name,
					this.container.hash
				);
				console.log(shouldUpload, uploadedList);
				if (!shouldUpload) {
					this.$message.success("ç§’ä¼ ï¼šä¸Šä¼ æˆåŠŸ");
					this.status = Status.wait;
					return;
				}
				this.data = fileChunkList.map(({
					file
				}, index) => ({
					fileHash: this.container.hash, //æ–‡ä»¶çš„hash
					index,
					hash: this.container.hash + "-" + index, //æ¯ä¸ªå—éƒ½æœ‰è‡ªå·±çš„index åœ¨å†…çš„hash, å¯æ’åºï¼Œ å¯è¿½è¸ª
					chunk: file,
					size: file.size,
					percentage: uploadedList.includes(index) ? 100 : 0 //å½“å‰åˆ‡ç‰‡æ˜¯å¦å·²ä¸Šä¼ è¿‡
				}));
				await this.uploadChunks(uploadedList); //ä¸Šä¼ åˆ‡ç‰‡
			},
			// ä¸Šä¼ åˆ‡ç‰‡ï¼ŒåŒæ—¶è¿‡æ»¤å·²ä¸Šä¼ çš„åˆ‡ç‰‡
			async uploadChunks(uploadedList = []) {
				// console.log(this.data);
				// æ•°æ®æ•°ç»„this.data => è¯·æ±‚æ•°ç»„ =ã€‹ å¹¶å‘
				const requestList = this.data
					.filter(({
						hash
					}) => !uploadedList.includes(hash))
					.map(({
						chunk,
						hash,
						index
					}) => {
						const formData = new FormData();
						formData.append("chunk", chunk);
						formData.append("hash", hash);
						formData.append("filename", this.container.file.name);
						formData.append("fileHash", this.container.hash);
						return {
							formData,
							index
						};
					})
					.map(async ({
							formData,
							index
						}) =>
						this.request({
							url: "http://localhost:3000",
							data: formData,
							onProgress: this.createProgressHandler(this.data[index]),
							requestList: this.requestList
						}));
				await Promise.all(requestList);
				// ä¹‹å‰ä¸Šä¼ çš„åˆ‡ç‰‡æ•°é‡+æœ¬æ¬¡ä¸Šä¼ çš„åˆ‡ç‰‡æ•°é‡=æ‰€æœ‰åˆ‡ç‰‡æ•°é‡
				if (uploadedList.length + requestList.length == this.data.length) {
					await this.mergeRequest();
				}
				console.log('å¯ä»¥å‘é€åˆå¹¶è¯·æ±‚äº†');
			},
			async mergeRequest() {
				await this.request({
					url: 'http://localhost:3000/merge',
					headers: {
						"content-type": "application/json"
					},
					data: JSON.stringify({
						size: SIZE,
						fileHash: this.container.hash,
						filename: this.container.file.name
					})
				})
				this.$message.success('ä¸Šä¼ æˆåŠŸ');
				this.status = Status.wait;
			},
			// ç”¨é—­åŒ…ä¿å­˜æ¯ä¸ª chunk çš„è¿›åº¦æ•°æ®
			createProgressHandler(item) {
				return e => {
					item.percentage = parseInt(String((e.loaded / e.total) * 100));
					console.log(e.loaded, e.total, '----------');
				}
			},
			// æ ¹æ® hash éªŒè¯æ–‡ä»¶æ˜¯å¦æ›¾ç»å·²ç»è¢«ä¸Šä¼ è¿‡
			// æ²¡æœ‰æ‰è¿›è¡Œä¸Šä¼ 
			async verifyUpload(filename, fileHash) {
				const {
					data
				} = await this.request({
					url: 'http://localhost:3000/verify',
					headers: {
						"content-type": "application/json"
					},
					data: JSON.stringify({ // å­—ç¬¦ä¸²åŒ–
						filename,
						fileHash
					})
				})
				return JSON.parse(data);
			},
			// es6çš„ç‰¹æ€§ä½ å’Œä»£ç æ˜¯å¦‚ä½•ç»“åˆçš„ï¼Ÿ å°‘ä¼ è¿™ä¸ªå‚æ•°
			createFileChunk(file, size = SIZE) {
				const fileChunkList = [];
				let cur = 0;
				while (cur < file.size) {
					fileChunkList.push({
						file: file.slice(cur, cur + size)
					})
					cur += size;
				}
				return fileChunkList;
			},
			handleFileChange(e) {
				const [file] = e.target.files;
				if (!file) return;
				this.resetData();
				Object.assign(this.$data, this.$options.data());
				this.container.file = file;
			},
		},
		components: {

		}
	}
</script>

<style>
	#app {
		font-family: 'Avenir', Helvetica, Arial, sans-serif;
		-webkit-font-smoothing: antialiased;
		-moz-osx-font-smoothing: grayscale;
		text-align: center;
		color: #2c3e50;
		margin-top: 60px;
	}
</style>
```

## ç§’ä¼ 

åŸç†ï¼šè®¡ç®—æ•´ä¸ªæ–‡ä»¶çš„`hash`ï¼Œåœ¨æ‰§è¡Œä¸Šä¼ æ“ä½œå‰ï¼Œå‘æœåŠ¡ç«¯å‘é€è¯·æ±‚ï¼Œä¼ é€’`MD5`å€¼ï¼Œåç«¯è¿›è¡Œæ–‡ä»¶æ£€ç´¢ã€‚è‹¥æœåŠ¡å™¨ä¸­å·²å­˜åœ¨è¯¥æ–‡ä»¶ï¼Œä¾¿ä¸è¿›è¡Œåç»­çš„ä»»ä½•æ“ä½œï¼Œä¸Šä¼ ä¹Ÿä¾¿ç›´æ¥ç»“æŸã€‚

å¤§æ–‡ä»¶ä¸Šä¼  + æ–­ç‚¹ç»­ä¼ çš„è§£å†³æ–¹æ¡ˆå°±å®Œæˆäº†

## æ€»ç»“

- å‰ç«¯ä¸Šä¼ å¤§æ–‡ä»¶æ—¶ä½¿ç”¨ `Blob.prototype.slice` å°†æ–‡ä»¶åˆ‡ç‰‡ï¼Œå¹¶å‘ä¸Šä¼ å¤šä¸ªåˆ‡ç‰‡ï¼Œæœ€åå‘é€ä¸€ä¸ªåˆå¹¶çš„è¯·æ±‚é€šçŸ¥æœåŠ¡ç«¯åˆå¹¶åˆ‡ç‰‡
- åç«¯è¿›è¡Œåˆå¹¶åˆ°æœ€ç»ˆæ–‡ä»¶,  åŸç”Ÿ `XMLHttpRequest` çš„ `upload.onprogress` å¯¹åˆ‡ç‰‡ä¸Šä¼ è¿›åº¦çš„ç›‘å¬
- ä½¿ç”¨ `spark-md5` æ ¹æ®æ–‡ä»¶å†…å®¹ç®—å‡ºæ–‡ä»¶ `hash`, é€šè¿‡ `hash` å¯ä»¥åˆ¤æ–­æœåŠ¡ç«¯æ˜¯å¦å·²ç»ä¸Šä¼ è¯¥æ–‡ä»¶ï¼Œä»è€Œç›´æ¥æç¤ºç”¨æˆ·ä¸Šä¼ æˆåŠŸï¼ˆç§’ä¼ ï¼‰
- å‰ç«¯åœ¨è®¡ç®—æ–‡ä»¶hashæ—¶ï¼Œèƒ½å¦å¼‚æ­¥å¹¶å®ç°è¿›åº¦å“åº”
- æ–‡ä»¶åˆ‡ç‰‡ä½¿ç”¨æŒä¹…åŒ–æˆ–è€…å†…å­˜å­˜å‚¨å¯¼è‡´æº¢å‡ºæ€ä¹ˆåŠï¼Ÿ
- â€œç»§ç»­ä¸‹è½½â€æ–¹æ¡ˆæ˜¯å¦è¿˜æœ‰ä¼˜åŒ–ç©ºé—´ï¼Ÿ
- åˆ†ç‰‡ä¸Šä¼ ã€æ¥æ”¶ã€å­˜å‚¨ã€åˆå¹¶ï¼Œè¿™äº›æ­¥éª¤æŠ½è±¡æˆä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ åè®®æ˜¯å¦æ›´ç†æƒ³
- ä¸Šä¼ çŠ¶æ€ç”±æœåŠ¡ç«¯åŠ¨æ€è·å–ï¼Œå‰ç«¯åªåšä¸¤ä¸ªäº‹ï¼šhashå’Œåˆ‡ç‰‡ã€‚è¿™ä¸ªå‰æä¸‹ï¼Œå¤šåˆ‡ç‰‡å¹¶å‘ä¸Šä¼ ã€å¤šæ–‡ä»¶å¹¶å‘ä¸Šä¼ ï¼Œå¤æ‚åº¦ä¼šæé«˜å¾ˆå¤šï¼Œå½“ç„¶ä¸»è¦æ˜¯åç«¯å¤æ‚åº¦ã€‚

## æºä»£ç 

- **[file-breakpoint-continue](https://github.com/webVueBlog/file-breakpoint-continue)**
