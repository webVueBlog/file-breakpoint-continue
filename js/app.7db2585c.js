(function(e){function t(t){for(var n,i,o=t[0],l=t[1],u=t[2],c=0,d=[];c<o.length;c++)i=o[c],Object.prototype.hasOwnProperty.call(s,i)&&s[i]&&d.push(s[i][0]),s[i]=0;for(n in l)Object.prototype.hasOwnProperty.call(l,n)&&(e[n]=l[n]);h&&h(t);while(d.length)d.shift()();return r.push.apply(r,u||[]),a()}function a(){for(var e,t=0;t<r.length;t++){for(var a=r[t],n=!0,o=1;o<a.length;o++){var l=a[o];0!==s[l]&&(n=!1)}n&&(r.splice(t--,1),e=i(i.s=a[0]))}return e}var n={},s={app:0},r=[];function i(t){if(n[t])return n[t].exports;var a=n[t]={i:t,l:!1,exports:{}};return e[t].call(a.exports,a,a.exports,i),a.l=!0,a.exports}i.m=e,i.c=n,i.d=function(e,t,a){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},i.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(i.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(a,n,function(t){return e[t]}.bind(null,n));return a},i.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/";var o=window["webpackJsonp"]=window["webpackJsonp"]||[],l=o.push.bind(o);o.push=t,o=o.slice();for(var u=0;u<o.length;u++)t(o[u]);var h=l;r.push([0,"chunk-vendors"]),a()})({0:function(e,t,a){e.exports=a("56d7")},"25e4":function(e,t,a){"use strict";a("261e")},"261e":function(e,t,a){},"56d7":function(e,t,a){"use strict";a.r(t);var n=a("2b0e"),s=function(){var e=this,t=e._self._c;return t("div",{attrs:{id:"app"}},[t("div",[t("input",{attrs:{type:"file",disabled:e.status!==e.Status.wait},on:{change:e.handleFileChange}}),t("el-button",{attrs:{disabled:e.uploadDisabled},on:{click:e.handleUpload}},[e._v("上传")]),e.status===e.Status.pause?t("el-button",{on:{click:e.handleResume}},[e._v("恢复")]):t("el-button",{attrs:{disabled:e.status!==e.Status.uploading||!e.container.hash},on:{click:e.handlePause}},[e._v("暂停 ")])],1),t("div",[t("div",[e._v("计算文件hash")]),t("el-progress",{attrs:{percentage:e.hashPercentage}}),t("div",[e._v("总进度")]),t("el-progress",{attrs:{percentage:e.fakeUploadPercentage}})],1),t("el-table",{attrs:{data:e.data}},[t("el-table-column",{attrs:{prop:"hash",label:"切片hash",align:"center"}}),t("el-table-column",{attrs:{label:"大小(kb)",align:"center",width:"120"},scopedSlots:e._u([{key:"default",fn:function({row:t}){return[e._v(" "+e._s(e._f("transformByte")(t.size))+" ")]}}])}),t("el-table-column",{attrs:{label:"进度",align:"center"},scopedSlots:e._u([{key:"default",fn:function({row:e}){return[t("el-progress",{attrs:{percentage:e.percentage,color:"#909399"}})]}}])})],1)],1)},r=[];a("caad"),a("13d5");const i=10485760,o={wait:"wait",pause:"pause",uploading:"uploading"};var l={name:"app",filters:{transformByte(e){return Number((e/1024).toFixed(0))}},computed:{uploadDisabled(){return!this.container.file||[o.pause,o.uploading].includes(this.status)},uploadPercentage(){if(!this.container.file||!this.data.length)return 0;const e=this.data.map(e=>e.size*e.percentage).reduce((e,t)=>e+t);return parseInt((e/this.container.file.size).toFixed(2))}},watch:{uploadPercentage(e){e>this.fakeUploadPercentage&&(this.fakeUploadPercentage=e)}},data:()=>({Status:o,container:{file:null,hash:"",worker:null},hashPercentage:0,data:[],requestList:[],status:o.wait,fakeUploadPercentage:0}),methods:{async handleResume(){this.status=o.uploading;const{uploadedList:e}=await this.verifyUpload(this.container.file.name,this.container.hash);await this.uploadChunks(e)},handlePause(){this.status=o.pause,this.resetData()},resetData(){this.requestList.forEach(e=>e.abort()),this.requestList=[],this.container.worker&&(this.container.worker.onmessage=null)},request({url:e,method:t="post",data:a,headers:n={},onProgress:s=(e=>e),requestList:r}){return new Promise(i=>{const o=new XMLHttpRequest;o.upload.onprogress=s,o.open(t,e),Object.keys(n).forEach(e=>o.setRequestHeader(e,n[e])),o.send(a),o.onload=e=>{if(r){const e=r.findIndex(e=>e===o);r.splice(e,1)}i({data:e.target.response})},null===r||void 0===r||r.push(o)})},async calculateHash(e){return new Promise(t=>{this.container.worker=new Worker("/hash.js"),this.container.worker.postMessage({fileChunkList:e}),this.container.worker.onmessage=e=>{const{percentage:a,hash:n}=e.data;console.log(a,"----"),this.hashPercentage=a,n&&t(n)}})},async handleUpload(e){if(!this.container.file)return;this.status=o.uploading;const t=this.createFileChunk(this.container.file);console.log(t),this.container.hash=await this.calculateHash(t);const{shouldUpload:a,uploadedList:n}=await this.verifyUpload(this.container.file.name,this.container.hash);if(console.log(a,n),!a)return this.$message.success("秒传：上传成功"),void(this.status=o.wait);this.data=t.map(({file:e},t)=>({fileHash:this.container.hash,index:t,hash:this.container.hash+"-"+t,chunk:e,size:e.size,percentage:n.includes(t)?100:0})),await this.uploadChunks(n)},async uploadChunks(e=[]){const t=this.data.filter(({hash:t})=>!e.includes(t)).map(({chunk:e,hash:t,index:a})=>{const n=new FormData;return n.append("chunk",e),n.append("hash",t),n.append("filename",this.container.file.name),n.append("fileHash",this.container.hash),{formData:n,index:a}}).map(async({formData:e,index:t})=>this.request({url:"http://localhost:3000",data:e,onProgress:this.createProgressHandler(this.data[t]),requestList:this.requestList}));await Promise.all(t),e.length+t.length==this.data.length&&await this.mergeRequest(),console.log("可以发送合并请求了")},async mergeRequest(){await this.request({url:"http://localhost:3000/merge",headers:{"content-type":"application/json"},data:JSON.stringify({size:i,fileHash:this.container.hash,filename:this.container.file.name})}),this.$message.success("上传成功"),this.status=o.wait},createProgressHandler(e){return t=>{e.percentage=parseInt(String(t.loaded/t.total*100)),console.log(t.loaded,t.total,"----------")}},async verifyUpload(e,t){const{data:a}=await this.request({url:"http://localhost:3000/verify",headers:{"content-type":"application/json"},data:JSON.stringify({filename:e,fileHash:t})});return JSON.parse(a)},createFileChunk(e,t=i){const a=[];let n=0;while(n<e.size)a.push({file:e.slice(n,n+t)}),n+=t;return a},handleFileChange(e){const[t]=e.target.files;t&&(this.resetData(),Object.assign(this.$data,this.$options.data()),this.container.file=t)}},components:{}},u=l,h=(a("25e4"),a("2877")),c=Object(h["a"])(u,s,r,!1,null,null,null),d=c.exports,p=a("5c96"),f=a.n(p);a("0fae");n["default"].use(f.a),n["default"].config.productionTip=!1,new n["default"]({render:e=>e(d)}).$mount("#app")}});
//# sourceMappingURL=app.7db2585c.js.map